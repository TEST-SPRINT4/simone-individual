<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/LogoSemFundo.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST | Dashboards</title>

    <link rel="stylesheet" href="../css/equipe.css">
    <!-- <script src="../js/funcoes.js"></script> -->
    <!-- <script src="../js/cadastro_funcionario.js"></script> -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body>

    <!-- INICIANDO NAVBAR SUPERIOR -->
    <div class="nav-bar">
        <div class="container-nav-bar">
            <img src="../assets/icon/LogoSemFundo.png" alt="">

            <ul class="navbar">
                <li class="agora">
                    <a href="index.html">DASHBOARD</a>
                </li>
                <li>
                    <div class="">
                        <a href="../index.html">SAIR</a>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <div class="janela">

        <!-- INICIANDO NAV-BAR LATERAL -->
        <div class="header-left">

            <!-- DADOS DO USUÁRIO -->
            <div class="hello">
                <img src="../Imagens/icon_user.png" alt="">
                <div class="text-hello">
                    <h3><span id="b_usuario">usuário</span></h3>
                    <h4><span id="c_usuario">Nível de permissão</span></h4>
                </div>
            </div>

            <!-- SERVIDORES CADASTRADOS -->
            <div class="container-server">

                <!-- botão equipe -->
                <a href="./homeDashboard.html">
                    <div class="btn-nav">
                        <img class="img_icon" src="../Imagens/icon-casa-cinza.png" alt="">
                        <h3 style="margin-bottom: 11px;">Home</h3>
                    </div>
                </a>
                <br>

                <div class="btn-nav-server">
                    <img class="img_icon" src="../Imagens/icon-lupa-cinza.png" alt="">
                    <a href="./dashboard.html">
                        <h3>Monitorando</h3>
                    </a>
                </div>
                <br>

                <a href="./Individual/brudney.html">
                    <div class="btn-nav">
                        <img class="img_icon" src="../../Imagens/icons8-wi-fi-26.png" alt="">
                        <h3>Rede</h3>
                    </div>
                </a>

                <div class="btns-dash">
                    <!-- O gráfico é chamado de acordo com o id (fk_aquario) do banco  -->
                    <!-- <button class="btn-chart btn-server" onclick="exibirAquario(1)" id="btnAquario1">Servidor 1</button>
                    <button class="btn-chart btn-server" onclick="exibirAquario(2)" id="btnAquario2">Servidor 2</button>
                    <button class="btn-chart btn-server" onclick="exibirAquario(3)" id="btnAquario3">Servidor 3</button>
                    <button class="btn-chart btn-server" onclick="exibirAquario(4)" id="btnAquario4">Servidor 4</button> -->
                </div>
            </div>

            <!-- botão equipe -->
            <a href="./equipe.html">
                <div class="btn-nav-current">
                    <img class="img_icon" src="../Imagens/icon-equipe-preta.png" alt="">
                    <h3>Equipe</h3>
                </div>
            </a>

            <!-- Botão servidores -->
            <a href="./servidores.html">
                <div class="btn-nav">
                    <img class="img_icon" src="../Imagens/icon-servidor-cinza.png" alt="">

                    <h3>Servidores</h3>
                </div>
            </a>

            <!-- botão suporte -->
            <a href="#">
                <div class="btn-nav">
                    <img class="img_icon" src="../Imagens/icon-suporte-cinza.png" alt="">
                    <h3>Suporte</h3>
                </div>
            </a>

        </div>

        <!-- INICIANDO CADASRO DE EQUIPE -->
        <div class="alinhar_dash">
            <div class="dash">

                <div class="alerta_erro">
                    <div class="card_erro" id="cardErro">
                        <span id="mensagem_erro"></span>
                    </div>
                </div>

                <!-- INICIANDO CARDS FORMULARIO -->
                <div class="card-cadastro-equipe" id="cadastrarFun">


                    <div class="card-form">
                        <!-- INICIANDO CAMPOS DO FORMULARIO -->
                        <div class="text-field">
                            <label class="label" for="nome">NOME</label><br>
                            <input type="text" id="input_nome_cadastro" placeholder=" Digite o nome do funcionário"><br>

                            <label class="label" for="permissão">PERMISSÃO</label><br>
                            <select id="input_permissao_cadastro">
                                <option value="" disabled selected>Selecione...</option>
                                <option value=1>Visualizar</option>
                                <option value=2>Visualizar e editar</option>
                                <option value=3>Visualizar, editar, cadastrar, e excluir</option>
                            </select><br>

                            <label class="label" for="email">E-MAIL</label><br>
                            <input type="email" id="input_email_cadastro"
                                placeholder=" Digite o e-mail do funcionário"><br>

                            <label for="senha">SENHA</label><br>
                            <input type="password" id="input_senha_cadastro"
                                placeholder=" Digite uma senha para o funcionário"><br>


                            <label for="senha">CONFIRMAR SENHA</label><br>
                            <input type="password" id="input_confirmar_senha_cadastro"
                                placeholder=" Digite a senha novamente"><br>
                        </div>


                        <div class="container-button">
                            <button onclick="cadastrar_equipe()" class="botao-login">CADASTRAR <span
                                    class="seta">→</span></button>
                        </div>
                        <div class="cardErro"></div>
                    </div>

                    <div class="card-equipe">
                        <button class="btn-equipe" onclick="editarFuncionario()">
                            <h4>EDITAR FUNCIONÁRIO</h4>
                        </button>
                        <button class="btn-select" onclick="cadastrarFuncionario()">
                            <h2> ▷ CADASTRO DE FUNCIONÁRIO</h2>
                        </button>
                        <button class="btn-equipe" onclick="excluirFuncionario()">
                            <h4>EXCLUIR FUNCIONÁRIO</h4>
                        </button>
                    </div>
                </div>

                <div class="card-editar-equipe" id="editarFun">

                    <div class="card-form">
                        <!-- INICIANDO CAMPOS DO FORMULARIO -->
                        <div class="text-field">

                            <label class="label" for="email">E-MAIL DO FUNCIONÁRIO</label><br>
                            <input type="text" id="input_email_atualizar"
                                placeholder="Digite o e-mail do funcionário que terá alteração"><br>

                            <!-- <label class="label" for="nome">NOME</label><br>
                        <input type="text" id="input_email" placeholder=" Digite o nome do funcionário"><br> -->

                            <label class="label" for="nome">NOVA PERMISSÃO</label><br>
                            <select id="input_permissao_atualizar">
                                <option value="" disabled selected>Selecione...</option>
                                <option value=1>Visualizar</option>
                                <option value=2>Visualizar e editar</option>
                                <option value=3>Visualizar, editar, cadastrar e excluir</option>
                            </select><br>

                        </div>


                        <div class="container-button">
                            <button onclick="atualizar_equipe()" class="botao-login">ATUALIZAR <span
                                    class="seta">→</span></button>
                        </div>
                    </div>

                    <div class="card-equipe">
                        <button class="btn-select" onclick="editarFuncionario()">
                            <h2> ▷ EDITAR FUNCIONÁRIO</h2>
                        </button>
                        <button class="btn-equipe" onclick="cadastrarFuncionario()">
                            <h4>CADASTRAR FUNCIONÁRIO</h4>
                        </button>
                        <button class="btn-equipe" onclick="excluirFuncionario()">
                            <h4>EXCLUIR FUNCIONÁRIO</h4>
                        </button>
                    </div>
                </div>

                <div class="card-excluir-equipe" id="excluirFun">

                    <div class="card-form">
                        <!-- INICIANDO CAMPOS DO FORMULARIO -->
                        <div class="text-field">

                            <label class="label" for="email">E-MAIL DO FUNCIONÁRIO</label><br>
                            <input type="text" id="input_email_desativar"
                                placeholder=" Digite o e-mail do funcionário que será excluido"><br>
                        </div>

                        <div class="container-button">
                            <button onclick="desativarFuncionario()" class="botao-login">EXCLUIR <span
                                    class="seta">→</span></button>
                        </div>
                    </div>

                    <div class="card-equipe">
                        <button class="btn-equipe" onclick="editarFuncionario()">
                            <h4>EDITAR FUNCIONÁRIO</h4>
                        </button>
                        <button class="btn-equipe" onclick="cadastrarFuncionario()">
                            <h4>CADASTRAR FUNCIONÁRIO</h4>
                        </button>
                        <button class="btn-select" onclick="excluirFuncionario()">
                            <h2> ▷ EXCLUIR FUNCIONÁRIO</h2>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-cadastro-equipe">
                <div class="card-form">
                    
                    <input id="input_pesquisarFuncionario" oninput="pesquisarFuncionario()" type="text">

                    <table style="width:100%">

                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Permissão</th>
                            </tr>
                        <tbody id="body_funcionario">
                        </tbody>
                    </table>


                </div>
            </div>
        </div>



    </div>


</body>

</html>

<script>
    var nivel_acesso = sessionStorage.NIVEL_ACESSO;

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    if (nivel_acesso == 3) {
        c_usuario.innerHTML = "Administrador"
    }
    if (nivel_acesso == 2) {
        c_usuario.innerHTML = "Visualizador e Editor";

        var equipeDiv = document.querySelector(".btn-nav img[src*='icon-equipe-cinza.png']").parentElement;
        if (equipeDiv) {
            equipeDiv.style.display = "none";
        }
    }

    if (nivel_acesso == 1) {
        c_usuario.innerHTML = "Visualizador";

        // Ocultar a div do botão "Equipe"
        var equipeDiv = document.querySelector(".btn-nav img[src*='icon-equipe-cinza.png']").parentElement;
        if (equipeDiv) {
            equipeDiv.style.display = "none";
        }

        // Ocultar a div do botão "Servidores"
        var servidoresDiv = document.querySelector(".btn-nav img[src*='icon-servidor-cinza.png']").parentElement;
        if (servidoresDiv) {
            servidoresDiv.style.display = "none";
        }
    }

    function cadastrarFuncionario() {
        cadastrarFun.style.display = 'flex';
        editarFun.style.display = 'none';
        excluirFun.style.display = 'none';
    }

    function cadastrar_equipe() {
        var nome_cadastroVAR = input_nome_cadastro.value;
        var permissao_cadastroVAR = input_permissao_cadastro.value;
        var email_cadastroVAR = input_email_cadastro.value;
        var senha_cadastroVAR = input_senha_cadastro.value;
        var confirmar_senha_cadastroVAR = input_confirmar_senha_cadastro.value;
        var fk_instituicaoVAR = sessionStorage.FK_INSTITUICAO;

        if (nome_cadastroVAR == "" || permissao_cadastroVAR == "" || email_cadastroVAR == "" || senha_cadastroVAR
            == "" || confirmar_senha_cadastroVAR == "") {
            cardErro.style.display = "block"
            mensagem_erro.innerHTML = "Todos os campos são obrigatórios";
            setTimeout(function () {
                cardErro.style.display = "none";
            }, 3000);

            return false;
        }
        else if (email_cadastroVAR.indexOf("@") == -1 || email_cadastroVAR.indexOf(".") == -1) {
            cardErro.style.display = "block"
            mensagem_erro.innerHTML = "Email inválido, insira um email válido!";
            setTimeout(function () {
                cardErro.style.display = "none";
            }, 4000);
            finalizarAguardar();
            return false;

        }

        else if (!/[!@#\$%\^&\*\(\)\-_\+=\[\]{};':"\\|,.<>\/?]/.test(senha_cadastroVAR)) {
            cardErro.style.display = "block"
            mensagem_erro.innerHTML = "A senha deve conter 8 caracteres e 1 especial (ex: @ ! %)";
            setTimeout(function () {
                cardErro.style.display = "none";
            }, 4000);
            finalizarAguardar();
            return false;
        }

        else if (senha_cadastroVAR.length < 8) {
            cardErro.style.display = "block"
            mensagem_erro.innerHTML = "A senha deve conter 8 caracteres e 1 especial (ex: @ ! %)";
            setTimeout(function () {
                cardErro.style.display = "none";
            }, 4000);
            finalizarAguardar();
            return false;
        }

        else if (confirmar_senha_cadastroVAR != senha_cadastroVAR) {
            cardErro.style.display = "block"
            mensagem_erro.innerHTML = "Senhas não se coincidem";
            setTimeout(function () {
                cardErro.style.display = "none";
            }, 4000);
            finalizarAguardar();
            return false;
        }
        // Enviando o valor da nova input
        fetch("/funcionario/cadastrar_equipe/", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/funcionario.js
                nome_cadastroServer: nome_cadastroVAR,
                permissao_cadastroServer: permissao_cadastroVAR,
                email_cadastroServer: email_cadastroVAR,
                senha_cadastroServer: senha_cadastroVAR,
                fk_instituicaoServer: fk_instituicaoVAR,

            })

        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                cardErro.style.display = "block";

                mensagem_erro.innerHTML = `Cadastro do Funcionario: <b>${nome_cadastroVAR}</b> realizado com sucesso`;
                cardErro.style.borderColor = "green";
                setTimeout(function () {
                    location.reload()
                }, 3000);

                limparFormulario();

            } else {
                cardErro.style.display = "block";

                mensagem_erro.innerHTML = `Não foi possivel realizar o cadastro`;
                setTimeout(function () {
                    location.reload()
                }, 3000);
                finalizarAguardar();
                throw ("Houve um erro ao tentar realizar o cadastro do funcionario!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
        return false;
    }

    function editarFuncionario() {
        cadastrarFun.style.display = 'none';
        editarFun.style.display = 'flex';
        excluirFun.style.display = 'none';
    }

    function atualizar_equipe() {
        var email_atualizarVAR = input_email_atualizar.value;
        var permissao_atualizarVAR = input_permissao_atualizar.value;

        if (email_atualizarVAR == "" || permissao_atualizarVAR == "") {
            cardErro.style.display = "block"
            mensagem_erro.innerHTML = "Todos os campos são obrigatórios";
            setTimeout(function () {
                cardErro.style.display = "none";
            }, 3000);

            return false;
        }

        fetch("/funcionario/atualizar_equipe/", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/funcionario.js
                email_atualizarServer: email_atualizarVAR,
                permissao_atualizarServer: permissao_atualizarVAR,

            })

        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                cardErro.style.display = "block";

                mensagem_erro.innerHTML = `Atualização da permissão do funcionário realizada com sucesso`;
                cardErro.style.borderColor = "green";
                setTimeout(function () {
                    location.reload()
                }, 3000);

                limparFormulario();

            } else {
                cardErro.style.display = "block";

                mensagem_erro.innerHTML = `Não foi possivel realizar a atualização do funcionário`;
                setTimeout(function () {
                    location.reload()
                }, 3000);
                finalizarAguardar();
                throw ("Houve um erro ao tentar realizar a atualização do funcionário!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
        return false;
    }

    function excluirFuncionario() {
        excluirFun.style.display = 'flex';
        cadastrarFun.style.display = 'none';
        editarFun.style.display = 'none';
    }

    function desativarFuncionario() {
        var email_desativarVAR = input_email_desativar.value;


        if (email_desativarVAR == "") {
            cardErro.style.display = "block"
            mensagem_erro.innerHTML = "Insira um email para exclusão";
            setTimeout(function () {
                cardErro.style.display = "none";
            }, 3000);

            return false;
        }

        fetch("/funcionario/desativarFuncionario/", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/funcionario.js
                email_desativarServer: email_desativarVAR,

            })

        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                cardErro.style.display = "block";

                mensagem_erro.innerHTML = `Exclusão do funcionário realizada com sucesso`;
                cardErro.style.borderColor = "green";
                setTimeout(function () {
                    location.reload()
                }, 3000);

                limparFormulario();

            } else {
                cardErro.style.display = "block";

                mensagem_erro.innerHTML = `Não foi possivel realizar a exclusão do funcionário`;
                setTimeout(function () {
                    location.reload()
                }, 3000);
                finalizarAguardar();
                throw ("Houve um erro ao tentar realizar a exclusão do funcionário!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
        return false;
    }

    function pesquisarFuncionario() {
        var feed = document.getElementById("body_funcionario");
        feed.innerHTML = ""

        var caractere = input_pesquisarFuncionario.value
        var fk_instituicao = sessionStorage.FK_INSTITUICAO

        fetch("/funcionario/pesquisarFuncionario/", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                caractereServer: caractere,
                fk_instituicaoServer: fk_instituicao

            })

        }).then(function (resposta) {

            console.log("resposta: ", resposta);
            if (resposta.ok) {
                if (resposta.status == 204) {
                    var feed = document.getElementById("body_funcionario");
                    mensagem.innerHTML = "Nenhum resultado encontrado."
                    feed.appendChild(mensagem);
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    var feed = document.getElementById("body_funcionario");
                    feed.innerHTML = "";
                    for (let i = 0; i < resposta.length; i++) {
                        var funcionario = resposta[i];

                        // Cria uma nova linha na tabela
                        var novaLinha = feed.insertRow();

                        // <th>ID</th>
                        //         <th>Nome</th>
                        //         <th>Email</th>
                        //         <th>Permissão</th>

                        // Cria células para cada coluna
                        var ID = novaLinha.insertCell(0);
                        var nome = novaLinha.insertCell(1);
                        var email = novaLinha.insertCell(2);
                        var permissao = novaLinha.insertCell(3);


                        ID.innerHTML = funcionario.idfuncionario;
                        nome.innerHTML = funcionario.nome_funcionario;
                        email.innerHTML = funcionario.email;
                        permissao.innerHTML = funcionario.fk_nivelAcesso;

                    }

                    // finalizarAguardar();
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
            // finalizarAguardar();
        });
    }

</script>