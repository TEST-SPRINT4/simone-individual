<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/LogoSemFundo.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST | Dashboards</title>

    <!-- link do CSS -->
    <link rel="stylesheet" href="./CSS/brudney.css">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body onload="BuscarServidor()">

    <!-- INICIANDO NAVBAR SUPERIOR (logo e botão de sair) -->
    <div class="nav-bar">
        <div class="container-nav-bar">
            <img src="../../assets/icon/LogoSemFundo.png" alt="">
            <ul class="navbar">
                <li class="agora"><a href="index.html">DASHBOARD</a></li>
                <li><a href="../index.html">SAIR</a></li>
            </ul>
        </div>
    </div>

    <div class="janela">

        <!-- INICIANDO NAV-BAR LATERAL (telas da dashboard)-->
        <div class="header-left">

            <!-- DADOS DO USUÁRIO -->
            <div class="hello">
                <img src="../../Imagens/icon_user.png" alt="">
                <div class="text-hello">
                    <h3><span id="b_usuario">usuário</span></h3>
                    <h4><span id="c_usuario">Nível de permissão</span></h4>
                </div>
            </div>

            <!-- SERVIDORES CADASTRADOS -->
            <div class="container-server">

                <!-- botão home-->
                <a href="../homeDashboard.html">
                    <div class="btn-nav">
                        <img class="img_icon" src="../../Imagens/icon-casa-cinza.png" alt="">
                        <h3 style="margin-bottom: 11px;">Home</h3>
                    </div>
                </a><br>

                <!--servidores -->
                <div class="btn-nav-server">
                    <img class="img_icon" src="../../Imagens/icon-lupa-cinza.png" alt="">
                    <a href="../dashboard.html">
                        <h3>Monitorando</h3>
                    </a>
                </div><br>
                <div class="btns-dash"></div>
            </div>

            <!-- botão Individual Brudney -->
            <a href="./Individual/brudney.html">
                <div class="btn-nav">
                    <img class="img_icon" src="../../Imagens/icons8-wi-fi-26.png" alt="">
                    <h3>Rede</h3>
                </div>
            </a>

            <!-- botão equipe -->
            <a href="../equipe.html">
                <div class="btn-nav">
                    <img class="img_icon" src="../../Imagens/icon-equipe-cinza.png" alt="">
                    <h3>Equipe</h3>
                </div>
            </a>

            <!-- Botão servidores -->
            <a href="../servidores.html">
                <div class="btn-nav">
                    <img class="img_icon" src="../../Imagens/icon-servidor-cinza.png" alt="">
                    <h3>Servidores</h3>
                </div>
            </a>

            <!-- botão suporte -->
            <a href="#">
                <div class="btn-nav">
                    <img class="img_icon" src="../../Imagens/icon-suporte-cinza.png" alt="">
                    <h3>Suporte</h3>
                </div>
            </a>


        </div>

        <!-- INICIANDO TELA DASHBOARD -->

        <div class="dash">
            <div class="parteGrafico">
                <div class="dados_atuais">
                    <div class="campo_selecao_servidor">
                        <span>Servidor:</span>
                        <select name="empresas" id="lista_servidor">
                            <option selected>Selecione um Servidor</option>
                        </select>
                        <button
                            onclick="BuscarServidor(), BuscarDados_latencia(), BuscarDados_Pacotes_Recebidos(), BuscarDados_Pacotes_Enviados(), Buscar_IPV4(), Buscar_IP_publico()">BUSCAR</button>
                    </div>

                    <div class="campo_selecao_servidor">
                        <span>Latencia</span>
                        <h1><span id="ultima_medida_latencia">0</span>ms</h1>
                    </div>

                    <div class="campo_selecao_servidor">
                        <span>Pacotes Recebidos</span>
                        <h1><span id="ultima_medida_pc_recebidos">0</span>mb</h1>
                    </div>

                    <div class="campo_selecao_servidor">
                        <span>Pacotes Enviados</span>
                        <h1><span id="ultima_medida_pc_enviados">0</span>mb</h1>
                    </div>
                </div>

                <!-- INICIANDO GRÁFICOS -->
                <div id="graficos">

                    <div id="grafico1" class="display-block">

                        <div class="parteGrafico">
                            <div class="graph">
                                <h3 class="tituloGraficos">
                                    <span id="tituloServidor_cpu1">Latência </span>
                                </h3>
                                <div class="label-captura">
                                    <p id="avisoCaptura1" style="color: rgb(206, 206, 206); text-align: center;"></p>
                                </div>
                                <canvas id="grafico_latencia"></canvas>
                            </div>

                            <!-- ------------------------------------------------------------------------ -->
                            <div class="graph2">
                                <img src="../../Imagens/wifi.png" alt="">
                                <div class="campo_detalhes_rede">
                                    <span><b>IP do Servidor:</b><span id="ip_monitorando">123.123</span></span>
                                    <span><b>IPV4 da Rede</b><span id="ipv4_atual">0.0.0.0</span></span>
                                    <span><b>IP Público da rede</b><span id="ip_publico_atual">0.0.0.0</span></span>
                                </div>
                            </div>
                        </div>
                        <!-- ---------------------------------------------------------------------- -->
                        <div class="parteGrafico">
                            <div class="graph">
                                <h3 class="tituloGraficos">
                                    <span id="tituloServidor_disco1">Pacotes - Recebidos</span>
                                </h3>
                                <canvas id="grafico_pacotes_recebidos"></canvas>
                                <div class="label-captura">
                                    <p id="avisoCaptura1" style="color: rgb(206, 206, 206); text-align: center;"></p>
                                </div>
                            </div>
                            <!-- ---------------------------------------------------------------------- -->
                            <div class="graph">
                                <h3 class="tituloGraficos">
                                    <span id="tituloServidor_enviados1">Pacotes - Enviados</span>
                                </h3>
                                <canvas id="grafico_pacotes_enviados"></canvas>
                                <div class="label-captura">
                                    <p id="avisoCaptura1" style="color: rgb(206, 206, 206); text-align: center;"></p>
                                </div>
                            </div>
                        </div>
                        <!-- ---------------------------------------------------------------------- -->
                    </div>
                </div>


            </div>
</body>

</html>
<script>

    var nivel_acesso = sessionStorage.NIVEL_ACESSO;

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    if (nivel_acesso == 3) {
        c_usuario.innerHTML = "Administrador"
    }
    if (nivel_acesso == 2) {
        c_usuario.innerHTML = "Visualizador e Editor";

        var equipeDiv = document.querySelector(".btn-nav img[src*='icon-equipe-cinza.png']").parentElement;
        if (equipeDiv) {
            equipeDiv.style.display = "none";
        }
    }

    if (nivel_acesso == 1) {
        c_usuario.innerHTML = "Visualizador";

        // Ocultar a div do botão "Equipe"
        var equipeDiv = document.querySelector(".btn-nav img[src*='icon-equipe-cinza.png']").parentElement;
        if (equipeDiv) {
            equipeDiv.style.display = "none";
        }

        // Ocultar a div do botão "Servidores"
        var servidoresDiv = document.querySelector(".btn-nav img[src*='icon-servidor-cinza.png']").parentElement;
        if (servidoresDiv) {
            servidoresDiv.style.display = "none";
        }
    }

    var dados_latencia = []
    var dados_pacotes_recebidos = []
    var dados_pacotes_enviados = []
    var dados_ipv4 = []
    var dados_ip_publico = []


    var horas_latencia = []
    var horas_pacotes_recebidos = []
    var horas_pacotes_enviados = []




    function BuscarServidor() {
        var idVar = sessionStorage.ID_USUARIO;

        sessionStorage.IP_ESCOLHIDO = lista_servidor.value;

        var servidorSelecionado = lista_servidor.options[lista_servidor.selectedIndex].text;

        ip_monitorando.innerHTML = `${servidorSelecionado}`

        fetch(`/servidor/BuscarServidor/${idVar}`)
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));

                        // Limpar as opções existentes
                        lista_servidor.innerHTML = '<option selected>Selecione um Servidor</option>';

                        // Iterar sobre os resultados e adicionar opções ao select
                        resposta.forEach(function (servidor) {
                            lista_servidor.innerHTML += `<option value="${servidor.idServidor}">${servidor.enderecoIP}</option>`;
                        });
                        dados_latencia = []
                        dados_pacotes_recebidos = []
                        dados_pacotes_enviados = []
                        dados_ipv4 = []
                        dados_ip_publico = []
                        dados_ip_publico = []

                        horas_latencia = []
                        horas_pacotes_recebidos = []
                        horas_pacotes_enviados = []

                        atualizarGrafico_Pacotes_Enviados()
                        atualizarGrafico_Pacotes_Recebidos()
                        atualizarGrafico_latencia()

                        ultima_medida_latencia.innerHTML = `0`
                        ultima_medida_pc_recebidos.innerHTML = `0`
                        ultima_medida_pc_enviados.innerHTML = `0`
                        ipv4_atual.innerHTML = `0.0.0.0`;
                        ip_publico_atual.innerHTML = `0.0.0.0`;


                    });
                } else {
                    console.log("Houve um erro ao tentar realizar o listar!");

                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }
            })
            .catch(function (erro) {
                console.log(erro);
            });

        return false;
    }

    const chart = new Chart('grafico_latencia', {
        type: 'line',
        data: {
            labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
            datasets: [{
                label: 'Teste',
                data: [],
                backgroundColor: 'rgba(255, 99, 132)',
                borderColor: 'rgba(255, 99, 132)',
                borderWidth: 1
            }
            ]
        }
    });

    const chart1 = new Chart('grafico_pacotes_recebidos', {
        type: 'line',
        data: {
            labels: [1, 2, 3, 4, 5, 6, 7],
            datasets: [{
                label: 'Teste',
                data: [],
                backgroundColor: 'rgba(255, 99, 132)',
                borderColor: 'rgba(255, 99, 132)',
                borderWidth: 1
            }
            ]
        }
    });

    const chart2 = new Chart('grafico_pacotes_enviados', {
        type: 'line',
        data: {
            labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
            datasets: [{
                label: 'Teste',
                data: [],
                backgroundColor: 'rgba(255, 99, 132)',
                borderColor: 'rgba(255, 99, 132)',
                borderWidth: 1
            }
            ]
        }
    });


    function BuscarDados_latencia() {
        var fkEmpresa = sessionStorage.FK_INSTITUICAO;
        var ipServidor = sessionStorage.IP_ESCOLHIDO;


        fetch("/rede/BuscarDados_latencia/", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/funcionario.js
                fkEmpresaServer: fkEmpresa,
                ipServidor: ipServidor,

            })

        }).then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Erro na requisição.');
            }
        })

            .then(function (resposta) {

                console.log("resposta latencia: ", resposta);

                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                ultima_medida_latencia.innerHTML = `${parseFloat(resposta[resposta.length - 1].dadosCapturados).toFixed(2)}`;


                var hora = new Date(resposta[0].dataHora).toLocaleString("pt-BR")


                // dados_latencia = []
                // for (let i = 0; i < resposta.length; i++) {

                if (dados_latencia.length < 7) {
                    dados_latencia.push(resposta[0].dadosCapturados)
                } else {
                    dados_latencia.shift()
                    dados_latencia.push(resposta[0].dadosCapturados)
                }

                if (horas_latencia.length < 7) {
                    horas_latencia.push(hora)
                } else {
                    horas_latencia.shift()
                    horas_latencia.push(hora)
                }
                // }

                atualizarGrafico_latencia()
                setTimeout(BuscarDados_latencia, 4000)

            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function atualizarGrafico_latencia() {
        const datasets = chart.data.datasets

        datasets[0].data = dados_latencia

        chart.update()
    }

    // setInterval(atualizarGrafico_latencia, 1000)

    function BuscarDados_Pacotes_Recebidos() {
        var fkEmpresa = sessionStorage.FK_INSTITUICAO;
        var ipServidor = sessionStorage.IP_ESCOLHIDO;


        fetch("/rede/BuscarDados_Pacotes_Recebidos/", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/funcionario.js
                fkEmpresaServer: fkEmpresa,
                ipServidor: ipServidor,

            })

        }).then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Erro na requisição.');
            }
        })

            .then(function (resposta) {

                var hora = new Date(resposta[0].dataHora).toLocaleString("pt-BR")

                console.log("resposta pacotes recebidos: ", resposta);

                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                ultima_medida_pc_recebidos.innerHTML = `${resposta[resposta.length - 1].dadosCapturados}`;

                // dados_pacotes_recebidos = []
                // for (let i = 0; i < resposta.length; i++) {
                if (dados_pacotes_recebidos.length < 7) {
                    dados_pacotes_recebidos.push(resposta[0].dadosCapturados)
                } else {
                    dados_pacotes_recebidos.shift()
                    dados_pacotes_recebidos.push(resposta[0].dadosCapturados)
                }

                if (horas_pacotes_recebidos.length < 7) {
                    horas_pacotes_recebidos.push(hora)
                } else {
                    horas_pacotes_recebidos.shift()
                    horas_pacotes_recebidos.push(hora)
                }
                // }

                atualizarGrafico_Pacotes_Recebidos()
                setTimeout(BuscarDados_Pacotes_Recebidos, 4000)

            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function atualizarGrafico_Pacotes_Recebidos() {
        // const dataHora = chart1.data.labels
        const datasets = chart1.data.datasets

        // dataHora = horas_pacotes_recebidos
        // chart1.update()

        datasets[0].data = dados_pacotes_recebidos
        chart1.update()
    }

    function BuscarDados_Pacotes_Enviados() {
        var fkEmpresa = sessionStorage.FK_INSTITUICAO;
        var ipServidor = sessionStorage.IP_ESCOLHIDO;


        fetch("/rede/BuscarDados_Pacotes_Enviados/", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/funcionario.js
                fkEmpresaServer: fkEmpresa,
                ipServidor: ipServidor,

            })

        }).then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Erro na requisição.');
            }
        })

            .then(function (resposta) {

                console.log("resposta pacotes enviados: ", resposta);

                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                ultima_medida_pc_enviados.innerHTML = `${resposta[resposta.length - 1].dadosCapturados}`;

                var hora = new Date(resposta[0].dataHora).toLocaleString("pt-BR")


                // dados_pacotes_enviados = []
                // for (let i = 0; i < resposta.length; i++) {

                if (dados_pacotes_enviados.length < 7) {
                    dados_pacotes_enviados.push(resposta[0].dadosCapturados)
                } else {
                    dados_pacotes_enviados.shift()
                    dados_pacotes_enviados.push(resposta[0].dadosCapturados)
                }

                if (horas_pacotes_enviados.length < 7) {
                    horas_pacotes_enviados.push(hora)
                } else {
                    horas_pacotes_enviados.shift()
                    horas_pacotes_enviados.push(hora)
                }
                // }

                atualizarGrafico_Pacotes_Enviados()
                setTimeout(BuscarDados_Pacotes_Enviados, 4000)

            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function atualizarGrafico_Pacotes_Enviados() {
        const datasets = chart2.data.datasets

        datasets[0].data = dados_pacotes_enviados

        chart2.update()
    }

    function Buscar_IPV4() {
        var fkEmpresa = sessionStorage.FK_INSTITUICAO;
        var ipServidor = sessionStorage.IP_ESCOLHIDO;


        fetch("/rede/Buscar_IPV4/", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/funcionario.js
                fkEmpresaServer: fkEmpresa,
                ipServidor: ipServidor,

            })

        }).then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Erro na requisição.');
            }
        })

            .then(function (resposta) {
                console.log("resposta ipv4: ", resposta);

                if (resposta.length > 0) {
                    var ultimoIPv4 = resposta[resposta.length - 1].IPV4;
                    ipv4_atual.innerHTML = ultimoIPv4;
                    atualizarGrafico_latencia();
                } else {
                    console.log("Nenhum dado IPv4 recebido na resposta.");
                }

                // Agende a próxima chamada após 4000 milissegundos (4 segundos)
                setTimeout(Buscar_IPV4, 4000);
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function Buscar_IP_publico() {
        var fkEmpresa = sessionStorage.FK_INSTITUICAO;
        var ipServidor = sessionStorage.IP_ESCOLHIDO;


        fetch("/rede/Buscar_IP_publico/", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },

            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/funcionario.js
                fkEmpresaServer: fkEmpresa,
                ipServidor: ipServidor,

            })

        }).then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Erro na requisição.');
            }
        })

            .then(function (resposta) {
                console.log("resposta ip público: ", resposta);

                if (resposta.length > 0) {
                    var ultimo_ip_publico = resposta[resposta.length - 1].IPpublico;
                    ip_publico_atual.innerHTML = ultimo_ip_publico;
                    atualizarGrafico_latencia();
                } else {
                    console.log("Nenhum dado IPpublico recebido na resposta.");
                }

                // Agende a próxima chamada após 4000 milissegundos (4 segundos)
                setTimeout(Buscar_IP_publico, 4000);
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }


</script>